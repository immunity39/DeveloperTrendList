name: Update Trending

on:
  schedule:
    - cron: "30 15 * * *"  # 日次: 日本時間 24:30 = UTC 15:30
    - cron: "30 15 * * 1"  # 週次: 毎週月曜 日本時間 24:30
    - cron: "30 15 1 * *"  # 月次: 毎月1日 日本時間 24:30
    - cron: "30 15 1 1 *"  # 年次: 毎年1月1日 日本時間 24:30
  workflow_dispatch:
    inputs:
      target:
        description: 'Select update target'
        required: true
        type: choice
        options:
          - daily
          - weekly
          - monthly
          - yearly
          - all
        default: 'daily'

permissions:
  contents: write

jobs:
  daily:
    if: >
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'daily')) ||
      (github.event_name == 'schedule' &&
       startsWith(github.event.schedule.cron, '30 15 * * *'))
    runs-on: ubuntu-latest
    timeout-minutes: 100
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - run: pip install requests beautifulsoup4 feedparser
      - name: Run daily update
        run: python scripts/update_readme.py
      - run: |
          git config --local user.email "so_kaicyo@icloud.com"
          git config --local user.name "immunity39"
          git pull
          git add README.md
          git commit -m "Daily update" || echo "No changes"
          git push

  weekly:
    if: >
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'weekly')) ||
      (github.event_name == 'schedule' &&
       startsWith(github.event.schedule.cron, '30 15 * * 1'))
    runs-on: ubuntu-latest
    timeout-minutes: 100
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - run: pip install requests beautifulsoup4 feedparser
      - name: Run weekly update
        run: python scripts/weekly.py
      - run: |
          git config --local user.email "so_kaicyo@icloud.com"
          git config --local user.name "immunity39"
          git pull
          git add docs/WEEKLY.md
          git commit -m "Weekly update" || echo "No changes"
          git push

  monthly:
    if: >
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'monthly')) ||
      (github.event_name == 'schedule' &&
       startsWith(github.event.schedule.cron, '30 15 1 * *'))
    runs-on: ubuntu-latest
    timeout-minutes: 100
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - run: pip install requests beautifulsoup4 feedparser
      - name: Run monthly update
        run: python scripts/monthly.py
      - run: |
          git config --local user.email "so_kaicyo@icloud.com"
          git config --local user.name "immunity39"
          git pull
          git add docs/MONTHLY.md
          git commit -m "Monthly update" || echo "No changes"
          git push

  yearly:
    if: >
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.target == 'yearly')) ||
      (github.event_name == 'schedule' &&
       startsWith(github.event.schedule.cron, '30 15 1 1 *'))
    runs-on: ubuntu-latest
    timeout-minutes: 100
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - run: pip install requests beautifulsoup4 feedparser
      - name: Run yearly update
        run: python scripts/yearly.py
      - run: |
          git config --local user.email "so_kaicyo@icloud.com"
          git config --local user.name "immunity39"
          git pull
          git add docs/YEARLY.md
          git commit -m "Yearly update" || echo "No changes"
          git push

  all:
    if: >
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.target == 'all'
    needs: [daily, weekly, monthly, yearly]
    runs-on: ubuntu-latest
    steps:
      - run: echo "All updates completed"